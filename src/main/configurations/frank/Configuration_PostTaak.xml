<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">

    <Adapter name="Frank_PostTaak" active="${Frank_PostTaak.active}">
        <Receiver name="Frank_PostTaak">
            <ApiListener
                name="Frank_PostTaak"
                method="POST"
                uriPattern="/api/v1/taak"
                headerParams="Authorization" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="Exit" state="SUCCESS" code="201"/>
                <Exit name="Reject" state="REJECTED" />
                <Exit name="Exception" state="ERROR" />
            </Exits>

            <SenderPipe name="GetToken" storeResultInSessionKey="FrankToken" active="${Token_Authentication.Active}">
                <IbisLocalSender javaListener="Internal_GetToken"/>
            </SenderPipe>

            <XmlIfPipe name="CompareTokens" xpathExpression="substring-after($ClientToken, 'Token ') = $FrankToken" active="${Token_Authentication.Active}">
                <Param name="ClientToken" sessionKey="headers" xpathExpression="headers/header[@name='Authorization']"/>
                <Param name="FrankToken" sessionKey="FrankToken" xpathExpression="//token"/>
                <Forward name="then" path="JsonToXml" />
                <Forward name="else" path="RejectMessage" />
            </XmlIfPipe>

            <EchoPipe name="RejectMessage" getInputFromFixedValue="Token invalid" active="${Token_Authentication.Active}">
                <Forward name="success" path="Reject" />
            </EchoPipe>

            <Json2XmlValidatorPipe name="Json2XmlValidator" root="root" schema="xsd/ValidatePostTaakInput.xsd">
                <Forward name="failure" path="Reject" />
                <Forward name="exception" path="StoreStackTrace" />
            </Json2XmlValidatorPipe>

            <SenderPipe name="SwitchConfiguration">
                <IbisLocalSender javaListener="Ultimo_PostZaak" />
                <Forward name="success" path="Exit" />
                <Forward name="exception" path="StoreStackTrace" />
            </SenderPipe>

            <PutInSessionPipe name="StoreStackTrace" sessionKey="errorStackTrace"/>
            
            <XsltPipe name="ReturnErrorMessage" xpathExpression="concat('Something went wrong. Stack trace: ', $errorStackTrace)">
                <Param name="errorStackTrace" sessionKey="errorStackTrace"/>
                <Forward name="success" path="Exception" />
            </XsltPipe>
        </Pipeline>
    </Adapter>
</Module>
